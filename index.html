<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogo Multimediale</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input[type=text], select { padding: 6px; margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; max-width: 900px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    input.qty, input.price { width: 80px; }
    input.client { width: 300px; margin-bottom: 20px; padding: 6px; }
    button { margin-top: 15px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>

  <h2>Catalogo Multimediale</h2>

  <label>Nome Cliente: <input type="text" id="clientName" class="client" placeholder="Inserisci nome cliente"></label><br>

  <label>Ricerca articolo: <input type="text" id="searchInput" placeholder="Cerca per codice o descrizione"></label>

  <table id="catalogTable">
    <thead>
      <tr>
        <th>Quantità</th>
        <th>Prezzo</th>
        <th>Categoria</th>
        <th>Codice</th>
        <th>Descrizione</th>
      </tr>
    </thead>
    <tbody>
      <!-- righe generate dinamicamente -->
    </tbody>
  </table>

  <button id="exportBtn">Esporta Ordine in Excel</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const csvUrl = 'https://raw.githubusercontent.com/mosynaa/cil/main/catalogo.csv';

    let catalogData = [];
    let filteredData = [];
    let qtyMap = new Map();
    let priceMap = new Map();
    let categoryMap = new Map();
    let categories = new Set();

    const clientNameInput = document.getElementById('clientName');
    const searchInput = document.getElementById('searchInput');
    const catalogTableBody = document.querySelector('#catalogTable tbody');
    const exportBtn = document.getElementById('exportBtn');

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',');
      const data = [];
      for(let i=1; i<lines.length; i++) {
        let obj = {};
        let currentLine = lines[i].split(',');
        for(let j=0; j<headers.length; j++) {
          obj[headers[j].trim()] = currentLine[j] ? currentLine[j].trim() : '';
        }
        data.push(obj);
      }
      return data;
    }

    function renderTable() {
      catalogTableBody.innerHTML = '';

      filteredData.forEach(item => {
        const codice = item.codice;
        const descrizione = item.descrizione;
        const categoria = item.categoria;

        categories.add(categoria);

        const qtyVal = qtyMap.get(codice) || '';
        const priceVal = priceMap.get(codice) || '';
        const selectedCategory = categoryMap.get(codice) || categoria;

        const row = document.createElement('tr');

        const categoryOptions = Array.from(categories).map(cat => {
          return `<option value="${cat}" ${cat === selectedCategory ? 'selected' : ''}>${cat}</option>`;
        }).join('');

        row.innerHTML = `
          <td><input type="text" class="qty" data-codice="${codice}" value="${qtyVal}" placeholder=""></td>
          <td><input type="text" class="price" data-codice="${codice}" value="${priceVal}" placeholder=""></td>
          <td>
            <select class="category" data-codice="${codice}">
              ${categoryOptions}
            </select>
          </td>
          <td>${codice}</td>
          <td>${descrizione}</td>
        `;
        catalogTableBody.appendChild(row);
      });

      document.querySelectorAll('input.qty').forEach(input => {
        input.oninput = (e) => {
          const cod = e.target.dataset.codice;
          const val = e.target.value.trim();
          if(val === '') qtyMap.delete(cod);
          else qtyMap.set(cod, val);
        };
      });

      document.querySelectorAll('input.price').forEach(input => {
        input.oninput = (e) => {
          const cod = e.target.dataset.codice;
          const val = e.target.value.trim();
          if(val === '') priceMap.delete(cod);
          else priceMap.set(cod, val);
        };
      });

      document.querySelectorAll('select.category').forEach(select => {
        select.onchange = (e) => {
          const cod = e.target.dataset.codice;
          const val = e.target.value;
          categoryMap.set(cod, val);
        };
      });
    }

    function filterCatalog() {
      const term = searchInput.value.toLowerCase();
      if(term === '') {
        filteredData = catalogData.slice();
      } else {
        filteredData = catalogData.filter(item =>
          item.codice.toLowerCase().includes(term) ||
          item.descrizione.toLowerCase().includes(term)
        );
      }
      renderTable();
    }

    function exportToExcel() {
      const clientName = clientNameInput.value.trim();
      if(clientName === '') {
        alert('Inserisci il nome cliente!');
        return;
      }

      const ws_data = [];
      ws_data.push(['Cliente:', clientName]);
      ws_data.push(['Quantità', 'Prezzo', 'Categoria', 'Codice', 'Descrizione']);

      filteredData.forEach(item => {
        const cod = item.codice;
        const descr = item.descrizione;

        let prezzo = priceMap.get(cod);
        if(!prezzo || prezzo === '') prezzo = 'P.P.';

        let qta = qtyMap.get(cod);
        if(!qta || qta === '') {
          qta = '';
        } else {
          if(/^\d+$/.test(qta)) {
            qta = 'CT';
          }
        }

        const categoria = categoryMap.get(cod) || item.categoria;

        ws_data.push([qta, prezzo, categoria, cod, descr]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      XLSX.utils.book_append_sheet(wb, ws, "Ordine");

      XLSX.writeFile(wb, `ordine_${clientName.replace(/\s+/g,'_')}.xlsx`);
    }

    fetch(csvUrl)
      .then(resp => resp.text())
      .then(text => {
        catalogData = parseCSV(text);
        filteredData = catalogData.slice();
        renderTable();
      })
      .catch(err => {
        console.error('Errore nel caricamento CSV:', err);
        alert('Errore nel caricamento del catalogo. Controlla la connessione o il percorso del CSV.');
      });

    searchInput.addEventListener('input', filterCatalog);
    exportBtn.addEventListener('click', exportToExcel);
  </script>

</body>
</html>
