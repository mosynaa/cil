<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ordini - Catalogo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1rem;
    }
    h1 {
      text-align: center;
    }
    input, select {
      margin: 0.5rem 0;
      padding: 0.4rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.5rem;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
    .manual-row {
      background-color: #f9f9f9;
    }
    button {
      margin: 1rem 0;
      padding: 0.6rem 1rem;
    }
  </style>
</head>
<body>
  <h1>Catalogo Ordini</h1>
  
  <label for="cliente">Nome cliente:</label>
  <input type="text" id="cliente" placeholder="Nome cliente" />

  <h3>Aggiungi articolo personalizzato</h3>
  <div class="manual-row">
    <input type="text" id="manual-codice" placeholder="Codice" />
    <input type="text" id="manual-descrizione" placeholder="Descrizione" />
    <input type="number" id="manual-quantita" placeholder="Quantità" />
    <input type="text" id="manual-prezzo" placeholder="Prezzo" />
  </div>

  <input type="text" id="search" placeholder="Cerca nel catalogo" />

  <table id="catalogo">
    <thead>
      <tr>
        <th>Codice</th>
        <th>Descrizione</th>
        <th>Categoria</th>
        <th>Prezzo</th>
        <th>Quantità</th>
        <th>P.P.</th>
      </tr>
    </thead>
    <tbody id="catalogo-body"></tbody>
  </table>

  <button onclick="generaFile()">Genera Excel</button>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    let dati = {};
    let catalogo = [];

    async function caricaCatalogo() {
      const response = await fetch('https://raw.githubusercontent.com/mosynaa/ordinecil/main/catalogo.csv');
      const testo = await response.text();
      const righe = testo.trim().split('\n').slice(1);
      catalogo = righe.map(riga => {
        const [codice, descrizione, categoria, prezzo] = riga.split(',');
        return { codice, descrizione, categoria, prezzo };
      });
      mostraCatalogo();
    }

    function mostraCatalogo() {
      const searchValue = document.getElementById('search').value.toLowerCase();
      const corpo = document.getElementById('catalogo-body');
      corpo.innerHTML = '';

      catalogo.forEach(articolo => {
        if (
          articolo.codice.toLowerCase().includes(searchValue) ||
          articolo.descrizione.toLowerCase().includes(searchValue) ||
          articolo.categoria.toLowerCase().includes(searchValue)
        ) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${articolo.codice}</td>
            <td>${articolo.descrizione}</td>
            <td>${articolo.categoria}</td>
            <td>${articolo.prezzo}</td>
            <td><input type="number" placeholder="CT" value="${dati[articolo.codice]?.quantita || ''}" onchange="salvaDati('${articolo.codice}', this.value, null)" /></td>
            <td><input type="text" placeholder="P.P." value="${dati[articolo.codice]?.prezzo || ''}" onchange="salvaDati('${articolo.codice}', null, this.value)" /></td>
          `;
          corpo.appendChild(tr);
        }
      });
    }

    function salvaDati(codice, quantita, prezzo) {
      if (!dati[codice]) dati[codice] = {};
      if (quantita !== null) dati[codice].quantita = quantita;
      if (prezzo !== null) dati[codice].prezzo = prezzo;
    }

    function generaFile() {
      const cliente = document.getElementById('cliente').value || 'Cliente';
      const righe = [['Cliente', cliente], ['Codice', 'Descrizione', 'Categoria', 'Prezzo', 'Quantità', 'P.P.']];

      // Articolo personalizzato
      const mCodice = document.getElementById('manual-codice').value;
      const mDescrizione = document.getElementById('manual-descrizione').value;
      const mQuantita = document.getElementById('manual-quantita').value;
      const mPrezzo = document.getElementById('manual-prezzo').value;
      if (mCodice || mDescrizione || mQuantita || mPrezzo) {
        righe.push([mCodice, mDescrizione, '', mPrezzo, mQuantita, '']);
      }

      catalogo.forEach(articolo => {
        if (dati[articolo.codice]?.quantita || dati[articolo.codice]?.prezzo) {
          righe.push([
            articolo.codice,
            articolo.descrizione,
            articolo.categoria,
            articolo.prezzo,
            dati[articolo.codice]?.quantita || '',
            dati[articolo.codice]?.prezzo || ''
          ]);
        }
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(righe);
      XLSX.utils.book_append_sheet(wb, ws, 'Ordine');
      XLSX.writeFile(wb, `${cliente}.xlsx`);
    }

    document.getElementById('search').addEventListener('input', mostraCatalogo);
    caricaCatalogo();
  </script>
</body>
</html>
