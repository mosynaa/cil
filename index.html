<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogo Ordini</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        input[type="text"], input[type="number"] { width: 60px; }
        #note, #cliente { width: 100%; margin: 10px 0; }
        .btn { padding: 5px 10px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        .btn:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>Catalogo Ordini</h1>
    <input type="text" id="search" placeholder="Cerca..." oninput="filtra()">
    <button class="btn" onclick="aggiungiArticoloManuale()">Aggiungi Articolo Manuale</button>
    <input type="text" id="cliente" placeholder="Nome Cliente">
    <textarea id="note" placeholder="Note"></textarea>
    <table id="tabellaCatalogo">
        <thead>
            <tr>
                <th>Codice</th>
                <th>Descrizione</th>
                <th>Categoria</th>
                <th>Prezzo</th>
                <th>Quantità</th>
                <th>P.P.</th>
            </tr>
        </thead>
        <tbody id="corpoTabella"></tbody>
    </table>
    <button class="btn" onclick="generaExcel()">Genera Excel</button>
    <button class="btn" onclick="generaPdf()">Genera PDF</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let dati = [];
        let datiFiltrati = [];
        const csvUrl = "https://raw.githubusercontent.com/mosynaa/ordinecil/main/catalogo.csv";

        fetch(csvUrl)
            .then(response => response.text())
            .then(csv => caricaCatalogo(csv));

        function caricaCatalogo(csv) {
            const righe = csv.split("\n").filter(r => r.trim() !== "");
            dati = righe.slice(1).map(riga => {
                const [codice, descrizione, categoria, prezzo] = riga.split(",");
                return { codice, descrizione, categoria, prezzo: prezzo || "P.P.", quantita: "" };
            });
            datiFiltrati = [...dati];
            mostraCatalogo();
        }

        function mostraCatalogo() {
            const corpo = document.getElementById("corpoTabella");
            corpo.innerHTML = "";
            datiFiltrati.forEach((item, index) => {
                const riga = document.createElement("tr");
                riga.innerHTML = `
                    <td>${item.codice}</td>
                    <td>${item.descrizione}</td>
                    <td>${item.categoria}</td>
                    <td><input type="number" placeholder="P.P." value="${item.prezzo !== "P.P." ? item.prezzo : ""}" onchange="salvaValore(${index}, 'prezzo', this.value)"></td>
                    <td><input type="number" placeholder="CT" value="${item.quantita}" onchange="salvaValore(${index}, 'quantita', this.value)"></td>
                `;
                corpo.appendChild(riga);
            });
        }

        function salvaValore(index, campo, valore) {
            const item = datiFiltrati[index];
            item[campo] = valore;
            const originale = dati.find(d => d.codice === item.codice);
            if (originale) originale[campo] = valore;
        }

        function filtra() {
            const testo = document.getElementById("search").value.toLowerCase();
            datiFiltrati = dati.filter(d => d.codice.toLowerCase().includes(testo) || d.descrizione.toLowerCase().includes(testo) || d.categoria.toLowerCase().includes(testo));
            mostraCatalogo();
        }

        function aggiungiArticoloManuale() {
            const nuovo = { codice: "", descrizione: "Articolo Manuale", categoria: "", prezzo: "", quantita: "" };
            dati.push(nuovo);
            datiFiltrati = [...dati];
            mostraCatalogo();
        }

        function generaExcel() {
            const cliente = document.getElementById("cliente").value;
            const note = document.getElementById("note").value;
            const wb = XLSX.utils.book_new();
            const wsData = [["Cliente", cliente], ["Note", note], [], ["Codice", "Descrizione", "Categoria", "Quantità", "Prezzo"]];
            dati.forEach(item => {
                if (item.quantita || item.prezzo) {
                    wsData.push([item.codice, item.descrizione, item.categoria, item.quantita || "CT", item.prezzo || "P.P."]);
                }
            });
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, "Ordine");
            XLSX.writeFile(wb, "ordine.xlsx");
        }

        async function generaPdf() {
            const {{ jsPDF }} = window.jspdf;
            const doc = new jsPDF();
            const cliente = document.getElementById("cliente").value;
            const note = document.getElementById("note").value;
            let y = 10;
            doc.text(`Cliente: ${cliente}`, 10, y);
            y += 10;
            doc.text(`Note: ${note}`, 10, y);
            y += 10;
            doc.text("Codice | Descrizione | Categoria | Quantità | Prezzo", 10, y);
            y += 10;
            dati.forEach(item => {
                if (item.quantita || item.prezzo) {
                    doc.text(`${item.codice} | ${item.descrizione} | ${item.categoria} | ${item.quantita || "CT"} | ${item.prezzo || "P.P."}`, 10, y);
                    y += 10;
                    if (y > 280) {
                        doc.addPage();
                        y = 10;
                    }
                }
            });
            doc.save("ordine.pdf");
        }
    </script>
</body>
</html>
