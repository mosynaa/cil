<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Catalogo Multimediale</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  input[type=text] { padding: 6px; width: 300px; margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; max-width: 900px; }
  th, td { border: 1px solid #ddd; padding: 8px; }
  th { background-color: #f2f2f2; }
  input.qty, input.price { width: 80px; }
  input.client { width: 300px; margin-bottom: 20px; padding: 6px; }
  button { margin-top: 15px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
</style>
</head>
<body>

<h2>Catalogo Multimediale</h2>

<label>Nome Cliente: <input type="text" id="clientName" class="client" placeholder="Inserisci nome cliente"></label><br>

<label>Ricerca articolo: <input type="text" id="searchInput" placeholder="Cerca per codice o descrizione"></label>

<table id="catalogTable">
  <thead>
    <tr>
      <th>Codice</th>
      <th>Descrizione</th>
      <th>Categoria</th>
      <th>Prezzo</th>
      <th>Quantità</th>
    </tr>
  </thead>
  <tbody>
    <!-- righe generate dinamicamente -->
  </tbody>
</table>

<button id="exportBtn">Esporta Ordine in Excel</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  const csvUrl = 'https://raw.githubusercontent.com/mosynaa/cil/main/catalogo.csv'; 

  let catalogData = []; // dati dal csv
  let filteredData = []; // dati filtrati in ricerca
  let qtyMap = new Map();   // per salvare quantità inserite, key = codice articolo
  let priceMap = new Map(); // per salvare prezzi inseriti, key = codice articolo

  const clientNameInput = document.getElementById('clientName');
  const searchInput = document.getElementById('searchInput');
  const catalogTableBody = document.querySelector('#catalogTable tbody');
  const exportBtn = document.getElementById('exportBtn');

  // Funzione per parse CSV semplice
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    const data = [];
    for(let i=1; i<lines.length; i++) {
      let obj = {};
      let currentLine = lines[i].split(',');
      for(let j=0; j<headers.length; j++) {
        obj[headers[j].trim()] = currentLine[j] ? currentLine[j].trim() : '';
      }
      data.push(obj);
    }
    return data;
  }

  // Mostra tabella filtrata e aggiorna i valori salvati
  function renderTable() {
    catalogTableBody.innerHTML = '';

    filteredData.forEach(item => {
      const codice = item.codice;

      // Prendo quantità e prezzo salvati o default vuoto
      const qtyVal = qtyMap.get(codice) || '';
      const priceVal = priceMap.get(codice) || '';

      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${codice}</td>
        <td>${item.descrizione}</td>
        <td>${item.categoria}</td>
        <td><input type="text" class="price" data-codice="${codice}" value="${priceVal}" placeholder=""></td>
        <td><input type="text" class="qty" data-codice="${codice}" value="${qtyVal}" placeholder=""></td>
      `;
      catalogTableBody.appendChild(row);
    });

    // Aggiungo eventi input per aggiornare mappe quantità e prezzi
    document.querySelectorAll('input.qty').forEach(input => {
      input.oninput = (e) => {
        const cod = e.target.dataset.codice;
        const val = e.target.value.trim();
        if(val === '') qtyMap.delete(cod);
        else qtyMap.set(cod, val);
      };
    });

    document.querySelectorAll('input.price').forEach(input => {
      input.oninput = (e) => {
        const cod = e.target.dataset.codice;
        const val = e.target.value.trim();
        if(val === '') priceMap.delete(cod);
        else priceMap.set(cod, val);
      };
    });
  }

  // Funzione filtro ricerca
  function filterCatalog() {
    const term = searchInput.value.toLowerCase();
    if(term === '') {
      filteredData = catalogData.slice();
    } else {
      filteredData = catalogData.filter(item => 
        item.codice.toLowerCase().includes(term) ||
        item.descrizione.toLowerCase().includes(term)
      );
    }
    renderTable();
  }

  // Funzione per esportare in Excel
  function exportToExcel() {
    const clientName = clientNameInput.value.trim();
    if(clientName === '') {
      alert('Inserisci il nome cliente!');
      return;
    }

    // Creiamo array per Excel: una riga di intestazione + dati
    const ws_data = [];
    ws_data.push(['Cliente:', clientName]);
    ws_data.push(['Codice', 'Descrizione', 'Categoria', 'Prezzo', 'Quantità']);

    filteredData.forEach(item => {
      const cod = item.codice;
      const descr = item.descrizione;
      const cat = item.categoria;

      // Logica prezzo
      let prezzo = priceMap.get(cod);
      if(!prezzo || prezzo === '') prezzo = 'P.P.'; // prezzo vuoto = P.P.

      // Logica quantità
      let qta = qtyMap.get(cod);
      if(!qta || qta === '') {
        qta = ''; // vuoto se niente inserito
      } else {
        // Se quantità è solo numero puro => "CT"
        // Se quantità contiene anche testo, esci quello che ha scritto
        if(/^\d+$/.test(qta)) {
          qta = 'CT';
        }
      }

      ws_data.push([cod, descr, cat, prezzo, qta]);
    });

    // Creo il workbook e foglio
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    XLSX.utils.book_append_sheet(wb, ws, "Ordine");

    // Esporto
    XLSX.writeFile(wb, `ordine_${clientName.replace(/\s+/g,'_')}.xlsx`);
  }

  // Fetch CSV e inizializzo
  fetch(csvUrl)
    .then(resp => resp.text())
    .then(text => {
      catalogData = parseCSV(text);
      filteredData = catalogData.slice();
      renderTable();
    })
    .catch(err => {
      console.error('Errore nel caricamento CSV:', err);
      alert('Errore nel caricamento del catalogo. Controlla la connessione o il percorso del CSV.');
    });

  // Eventi
  searchInput.addEventListener('input', filterCatalog);
  exportBtn.addEventListener('click', exportToExcel);

</script>

</body>
</html>
